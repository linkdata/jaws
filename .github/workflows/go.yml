name: Go

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go:
          - "1.21"
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go }}

      - name: Install stringer
        run: go install golang.org/x/tools/cmd/stringer@latest

      - name: Generate
        run: go generate ./...

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -tags debug -bench=. -coverprofile=coverage.out ./...
      
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./...

      - name: Go report card
        uses: creekorful/goreportcard-action@v1.0
        continue-on-error: true

      # Generate code coverage badge and push it to the 'badges' branch.
      # Reference it in your README.md like this:
      #
      #  [![coverage](https://github.com/USERNAME/REPO/blob/badges/BRANCH/badge.svg)](#)
      #
      # To create the 'badges' branch for the repository:
      #
      #  git checkout BRANCH
      #  git checkout --orphan badges
      #  git rm --cached $(git ls-files)
      #  echo '# Badges branch' > README.md
      #  git add README.md
      #  git commit -m 'Add dedicated README'
      #  git push origin badges
      #  git checkout --force BRANCH

      - name: Extract code coverage
        id: coverage
        # Change this to extract the coverage percentage (without the percent sign) for your language.
        # Here we are using a 'coverage.out' file generated by 'go test -coverprofile=coverage.out ./...'
        run: echo "COVERAGE=$(go tool cover -func=coverage.out | grep total | tr -s '\t' | cut -f 3 | rev | cut -c2- | rev)" >> $GITHUB_OUTPUT
      - name: Extract branch name
        run: echo "BRANCH=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
        id: extract_branch
      - uses: actions/checkout@v3
        with:
          ref: badges
          path: badges
      - name: Create badges dir if necessary
        env:
          BRANCH: ${{ steps.extract_branch.outputs.branch }}
        run: mkdir -p badges/${BRANCH}
      - name: Generate the badge SVG image
        uses: emibcn/badge-action@v2.0.3
        with:
          label: 'coverage'
          status: ${{ steps.coverage.outputs.coverage }}%
          path: badges/${{ steps.extract_branch.outputs.branch }}/badge.svg
          color: ${{
                steps.coverage.outputs.coverage > 90 && 'green'              ||
                steps.coverage.outputs.coverage > 80 && 'yellow,green'       ||
                steps.coverage.outputs.coverage > 70 && 'yellow'             ||
                steps.coverage.outputs.coverage > 60 && 'orange,yellow'      ||
                steps.coverage.outputs.coverage > 50 && 'orange'             ||
                steps.coverage.outputs.coverage > 40 && 'red,orange'         ||
                steps.coverage.outputs.coverage > 30 && 'red,red,orange'     ||
                steps.coverage.outputs.coverage > 20 && 'red,red,red,orange' ||
                'red' }}
      - name: Commit badge
        # ignore errors because badge may not have changed
        continue-on-error: true
        env:
          BRANCH: ${{ steps.extract_branch.outputs.branch }}
        run: |
          pushd badges
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git add "${BRANCH}/badge.svg"
              git commit -m "Add/Update badge"
              git push
          popd

